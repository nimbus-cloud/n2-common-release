#!/var/vcap/bosh/bin/ruby
require 'time'

def drbd_state
  drbd = {}

  if File.file?("/proc/drbd")
    file = File.open("/proc/drbd", "r")
    file.each_line do |line|
      if line=~/cs:(\S+)\s+ro:(\S+)\s+ds:(\S+)/
        drbd["connection_state"]=$1
        drbd["role"]=$2
        drbd["disk_state"]=$3
      end
      if line=~/\s*[\[\>\.\]]+\s*sync'ed:\s*(.+)/
        drbd["sync_state"]=$1
      end
      if line=~/^\s*(finish:.+)$/
        drbd["sync_state"]="#{drbd["sync_state"]} #{$1}"
      end
    end
    file.close
  else
    drbd["connection_state"]="not running"
    drbd["role"]=""
    drbd["disk_state"]=""
    drbd["sync_state"]=""
  end
  drbd
end

def log(message)
  puts "#{Time.now.utc}: #{message}"
end

def fail(message)
  $stderr.puts "#{Time.now.utc}: #{message}"
  exit 1
end

def main
  log "Checking drbd status..."
  drbd = drbd_state
  if drbd["connection_state"] != "Connected"
    fail("Failed: connection state incorrect... current state is #{drbd["connection_state"]}")
  end
  if drbd["disk_state"] != "UpToDate/UpToDate"
    fail("Failed: disk state is not uptodate... current state is #{drbd["disk_state"]}")
  end
  puts "...all good"
  exit 0
end

main
